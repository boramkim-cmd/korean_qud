# 01. C# í•œê¸€ ì¡°ì‚¬ ì²˜ë¦¬ ëª¨ë“œ êµ¬í˜„ ê°€ì´ë“œ

**ë‚œì´ë„:** â­â­â­â­  
**ì˜ˆìƒ ì‹œê°„:** 2-3ì£¼  
**í•„ìš” ê¸°ìˆ :** C#, Unity, Harmony

---

## ğŸ¯ ì™„ì„± ëª©í‘œ

### ê¸°ëŠ¥
- âœ… í•œê¸€ ë°›ì¹¨ ìë™ ê°ì§€
- âœ… 5ê°€ì§€ ì¡°ì‚¬ ìë™ ì„ íƒ (ì´/ê°€, ì„/ë¥¼, ì€/ëŠ”, ìœ¼ë¡œ/ë¡œ, ì•„/ì•¼)
- âœ… ëª¨ë“  ë™ì  í…ìŠ¤íŠ¸ ì§€ì›
- âœ… ì„±ëŠ¥ ìµœì í™” (ìºì‹±)

### ì‚¬ìš© ì˜ˆì‹œ
```xml
<!-- ë²ˆì—­ íŒŒì¼ -->
<text><player.name><josa_i_ga> <item.name><josa_eul_reul> ë°œê²¬í–ˆë‹¤</text>

<!-- ê²Œì„ ë‚´ ê²°ê³¼ -->
"ì² ìˆ˜ê°€ ê²€ì„ ë°œê²¬í–ˆë‹¤"
"ì˜í¬ê°€ ì‚¬ê³¼ë¥¼ ë°œê²¬í–ˆë‹¤"
```

---

## ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
KoreanJosaHandler/
â”œâ”€â”€ manifest.json
â”œâ”€â”€ Scripts/
â”‚   â”œâ”€â”€ Core/
â”‚   â”‚   â”œâ”€â”€ JosaDetector.cs       (ë°›ì¹¨ ê°ì§€)
â”‚   â”‚   â”œâ”€â”€ JosaSelector.cs       (ì¡°ì‚¬ ì„ íƒ)
â”‚   â”‚   â””â”€â”€ TextProcessor.cs      (í…ìŠ¤íŠ¸ ì²˜ë¦¬)
â”‚   â”œâ”€â”€ Patches/
â”‚   â”‚   â”œâ”€â”€ ConversationPatch.cs  (ëŒ€í™” íŒ¨ì¹˜)
â”‚   â”‚   â”œâ”€â”€ QuestPatch.cs         (í€˜ìŠ¤íŠ¸ íŒ¨ì¹˜)
â”‚   â”‚   â””â”€â”€ ItemPatch.cs          (ì•„ì´í…œ íŒ¨ì¹˜)
â”‚   â””â”€â”€ Utils/
â”‚       â”œâ”€â”€ Cache.cs              (ìºì‹±)
â”‚       â””â”€â”€ Logger.cs             (ë¡œê¹…)
â”œâ”€â”€ Assemblies/
â”‚   â””â”€â”€ 0Harmony.dll              (Harmony ë¼ì´ë¸ŒëŸ¬ë¦¬)
â””â”€â”€ README.md
```

---

## ğŸ’» ì½”ë“œ êµ¬í˜„

### 1. JosaDetector.cs (ë°›ì¹¨ ê°ì§€)

```csharp
using System;

namespace KoreanJosaHandler.Core
{
    public static class JosaDetector
    {
        // í•œê¸€ ìœ ë‹ˆì½”ë“œ ë²”ìœ„
        private const int HANGUL_START = 0xAC00;
        private const int HANGUL_END = 0xD7A3;
        private const int JONGSEONG_COUNT = 28;
        
        /// <summary>
        /// ë‹¨ì–´ì˜ ë§ˆì§€ë§‰ ê¸€ìì— ë°›ì¹¨ì´ ìˆëŠ”ì§€ í™•ì¸
        /// </summary>
        public static bool HasJongseong(string word)
        {
            if (string.IsNullOrEmpty(word))
                return false;
            
            // íŠ¹ìˆ˜ë¬¸ì ì œê±° í›„ ë§ˆì§€ë§‰ ê¸€ì
            char lastChar = GetLastKoreanChar(word);
            
            // í•œê¸€ ë²”ìœ„ í™•ì¸
            if (lastChar < HANGUL_START || lastChar > HANGUL_END)
                return false; // í•œê¸€ì´ ì•„ë‹ˆë©´ ë°›ì¹¨ ì—†ìŒìœ¼ë¡œ ì²˜ë¦¬
            
            // ì¢…ì„±(ë°›ì¹¨) ê³„ì‚°
            int jongseong = (lastChar - HANGUL_START) % JONGSEONG_COUNT;
            
            return jongseong != 0;
        }
        
        /// <summary>
        /// ë¬¸ìì—´ì—ì„œ ë§ˆì§€ë§‰ í•œê¸€ ê¸€ì ì¶”ì¶œ
        /// </summary>
        private static char GetLastKoreanChar(string word)
        {
            for (int i = word.Length - 1; i >= 0; i--)
            {
                char c = word[i];
                if (c >= HANGUL_START && c <= HANGUL_END)
                    return c;
            }
            
            // í•œê¸€ì´ ì—†ìœ¼ë©´ ë§ˆì§€ë§‰ ë¬¸ì ë°˜í™˜
            return word[word.Length - 1];
        }
        
        /// <summary>
        /// 'ã„¹' ë°›ì¹¨ í™•ì¸ (ìœ¼ë¡œ/ë¡œ íŠ¹ìˆ˜ ì¼€ì´ìŠ¤)
        /// </summary>
        public static bool HasRieulJongseong(string word)
        {
            if (string.IsNullOrEmpty(word))
                return false;
            
            char lastChar = GetLastKoreanChar(word);
            
            if (lastChar < HANGUL_START || lastChar > HANGUL_END)
                return false;
            
            int jongseong = (lastChar - HANGUL_START) % JONGSEONG_COUNT;
            
            // ã„¹ ë°›ì¹¨ì€ 8ë²ˆ
            return jongseong == 8;
        }
    }
}
```

### 2. JosaSelector.cs (ì¡°ì‚¬ ì„ íƒ)

```csharp
using System;

namespace KoreanJosaHandler.Core
{
    public enum JosaType
    {
        Subject,    // ì´/ê°€
        Object,     // ì„/ë¥¼
        Topic,      // ì€/ëŠ”
        Direction,  // ìœ¼ë¡œ/ë¡œ
        Vocative    // ì•„/ì•¼
    }
    
    public static class JosaSelector
    {
        /// <summary>
        /// ë‹¨ì–´ì— ë§ëŠ” ì¡°ì‚¬ ì„ íƒ
        /// </summary>
        public static string SelectJosa(string word, JosaType type)
        {
            if (string.IsNullOrEmpty(word))
                return GetDefaultJosa(type);
            
            bool hasJongseong = JosaDetector.HasJongseong(word);
            
            switch (type)
            {
                case JosaType.Subject:
                    return hasJongseong ? "ì´" : "ê°€";
                
                case JosaType.Object:
                    return hasJongseong ? "ì„" : "ë¥¼";
                
                case JosaType.Topic:
                    return hasJongseong ? "ì€" : "ëŠ”";
                
                case JosaType.Direction:
                    // ã„¹ ë°›ì¹¨ íŠ¹ìˆ˜ ì²˜ë¦¬
                    if (JosaDetector.HasRieulJongseong(word))
                        return "ë¡œ";
                    return hasJongseong ? "ìœ¼ë¡œ" : "ë¡œ";
                
                case JosaType.Vocative:
                    return hasJongseong ? "ì•„" : "ì•¼";
                
                default:
                    return "";
            }
        }
        
        /// <summary>
        /// ì¡°ì‚¬ íƒ€ì… ë¬¸ìì—´ì„ enumìœ¼ë¡œ ë³€í™˜
        /// </summary>
        public static JosaType ParseJosaType(string typeStr)
        {
            switch (typeStr.ToLower())
            {
                case "i_ga":
                case "subject":
                    return JosaType.Subject;
                
                case "eul_reul":
                case "object":
                    return JosaType.Object;
                
                case "eun_neun":
                case "topic":
                    return JosaType.Topic;
                
                case "euro_ro":
                case "direction":
                    return JosaType.Direction;
                
                case "a_ya":
                case "vocative":
                    return JosaType.Vocative;
                
                default:
                    return JosaType.Subject;
            }
        }
        
        private static string GetDefaultJosa(JosaType type)
        {
            // ë¹ˆ ë¬¸ìì—´ì¼ ë•Œ ê¸°ë³¸ê°’ (ë°›ì¹¨ ì—†ìŒìœ¼ë¡œ ê°€ì •)
            switch (type)
            {
                case JosaType.Subject: return "ê°€";
                case JosaType.Object: return "ë¥¼";
                case JosaType.Topic: return "ëŠ”";
                case JosaType.Direction: return "ë¡œ";
                case JosaType.Vocative: return "ì•¼";
                default: return "";
            }
        }
    }
}
```

### 3. TextProcessor.cs (í…ìŠ¤íŠ¸ ì²˜ë¦¬)

```csharp
using System;
using System.Text.RegularExpressions;
using XRL.World;

namespace KoreanJosaHandler.Core
{
    public static class TextProcessor
    {
        // íŒ¨í„´: <ë³€ìˆ˜><josa_type>
        private static readonly Regex JosaPattern = 
            new Regex(@"<([^>]+)><josa_(\w+)>", RegexOptions.Compiled);
        
        /// <summary>
        /// í…ìŠ¤íŠ¸ ë‚´ ì¡°ì‚¬ íƒœê·¸ ì²˜ë¦¬
        /// </summary>
        public static string Process(string text, GameObject context = null)
        {
            if (string.IsNullOrEmpty(text))
                return text;
            
            // ìºì‹œ í™•ì¸
            string cached = Cache.Get(text);
            if (cached != null)
                return cached;
            
            // ì¡°ì‚¬ íƒœê·¸ ì²˜ë¦¬
            string result = JosaPattern.Replace(text, match =>
            {
                string variable = match.Groups[1].Value;
                string josaTypeStr = match.Groups[2].Value;
                
                // ë³€ìˆ˜ ê°’ ê°€ì ¸ì˜¤ê¸°
                string value = ResolveVariable(variable, context);
                
                // ì¡°ì‚¬ íƒ€ì… íŒŒì‹±
                JosaType josaType = JosaSelector.ParseJosaType(josaTypeStr);
                
                // ì¡°ì‚¬ ì„ íƒ
                string josa = JosaSelector.SelectJosa(value, josaType);
                
                // ê²°ê³¼ ë°˜í™˜
                return value + josa;
            });
            
            // ìºì‹œ ì €ì¥
            Cache.Set(text, result);
            
            return result;
        }
        
        /// <summary>
        /// ë³€ìˆ˜ ê°’ ê°€ì ¸ì˜¤ê¸°
        /// </summary>
        private static string ResolveVariable(string variable, GameObject context)
        {
            // ê°„ë‹¨í•œ ë³€ìˆ˜ ì²˜ë¦¬
            if (variable.StartsWith("player."))
            {
                return GetPlayerProperty(variable.Substring(7));
            }
            else if (variable.StartsWith("item."))
            {
                return GetItemProperty(variable.Substring(5), context);
            }
            else if (variable.StartsWith("entity."))
            {
                return GetEntityProperty(variable.Substring(7), context);
            }
            
            // ê¸°ë³¸ê°’: ë³€ìˆ˜ëª… ê·¸ëŒ€ë¡œ ë°˜í™˜
            return variable;
        }
        
        private static string GetPlayerProperty(string property)
        {
            var player = XRLCore.Core?.Game?.Player?.Body;
            if (player == null)
                return "";
            
            switch (property)
            {
                case "name":
                    return player.DisplayName;
                default:
                    return "";
            }
        }
        
        private static string GetItemProperty(string property, GameObject context)
        {
            if (context == null)
                return "";
            
            switch (property)
            {
                case "name":
                    return context.DisplayName;
                default:
                    return "";
            }
        }
        
        private static string GetEntityProperty(string property, GameObject context)
        {
            if (context == null)
                return "";
            
            switch (property)
            {
                case "name":
                    return context.DisplayName;
                default:
                    return "";
            }
        }
    }
}
```

### 4. ConversationPatch.cs (Harmony íŒ¨ì¹˜)

```csharp
using HarmonyLib;
using XRL.UI;
using KoreanJosaHandler.Core;

namespace KoreanJosaHandler.Patches
{
    [HarmonyPatch(typeof(ConversationNode))]
    public class ConversationPatch
    {
        [HarmonyPatch("GetText")]
        [HarmonyPostfix]
        public static void GetText_Postfix(ref string __result)
        {
            try
            {
                __result = TextProcessor.Process(__result);
            }
            catch (System.Exception ex)
            {
                Logger.Error($"ConversationPatch error: {ex.Message}");
            }
        }
    }
    
    [HarmonyPatch(typeof(ConversationChoice))]
    public class ConversationChoicePatch
    {
        [HarmonyPatch("GetText")]
        [HarmonyPostfix]
        public static void GetText_Postfix(ref string __result)
        {
            try
            {
                __result = TextProcessor.Process(__result);
            }
            catch (System.Exception ex)
            {
                Logger.Error($"ConversationChoicePatch error: {ex.Message}");
            }
        }
    }
}
```

---

## ğŸ”§ ë¹Œë“œ ë° ë°°í¬

### 1. í”„ë¡œì íŠ¸ ë¹Œë“œ

```bash
# Visual Studioì—ì„œ ë¹Œë“œ
# ì¶œë ¥: KoreanJosaHandler.dll

# ë˜ëŠ” ëª…ë ¹ì¤„
csc /target:library /out:KoreanJosaHandler.dll /reference:0Harmony.dll /reference:Assembly-CSharp.dll Scripts/**/*.cs
```

### 2. ëª¨ë“œ í´ë” êµ¬ì„±

```
Mods/KoreanJosaHandler/
â”œâ”€â”€ manifest.json
â”œâ”€â”€ Assemblies/
â”‚   â”œâ”€â”€ KoreanJosaHandler.dll
â”‚   â””â”€â”€ 0Harmony.dll
â””â”€â”€ README.md
```

### 3. ê²Œì„ì— ì„¤ì¹˜

```
1. Mods í´ë”ë¥¼ Caves of Qud ì„¤ì¹˜ ê²½ë¡œì— ë³µì‚¬
2. ê²Œì„ ì‹¤í–‰
3. ëª¨ë“œ ë©”ë‰´ì—ì„œ í™œì„±í™”
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸

### ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

```csharp
[TestClass]
public class JosaDetectorTests
{
    [TestMethod]
    public void TestHasJongseong()
    {
        Assert.IsTrue(JosaDetector.HasJongseong("ê²€"));
        Assert.IsFalse(JosaDetector.HasJongseong("ì‚¬ê³¼"));
        Assert.IsFalse(JosaDetector.HasJongseong("ABC"));
        Assert.IsTrue(JosaDetector.HasJongseong("ì±…!"));  // íŠ¹ìˆ˜ë¬¸ì ë¬´ì‹œ
    }
    
    [TestMethod]
    public void TestHasRieulJongseong()
    {
        Assert.IsTrue(JosaDetector.HasRieulJongseong("ì„œìš¸"));
        Assert.IsFalse(JosaDetector.HasRieulJongseong("ì§‘"));
    }
}
```

---

**ì‘ì„±ì¼:** 2026-01-13  
**ë‚œì´ë„:** â­â­â­â­  
**ì˜ˆìƒ ì™„ë£Œ:** 2-3ì£¼
