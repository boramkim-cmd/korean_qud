# 조사 처리 시스템 작업 가이드

**작성일시:** 2026-01-13 10:13  
**상태:** ✅ 완료

---

## ✅ 완료된 작업

### 1. JosaHandler.cs 업데이트
- [x] Harmony 라이브러리 통합
- [x] Caves of Qud API 연동 (XRL 네임스페이스)
- [x] ModSensitiveCache 사용 (게임 권장 방식)
- [x] 4가지 Harmony 패치 구현

### 2. Harmony 패치 구현

#### Patch 1: ConversationNode
```csharp
[HarmonyPatch(typeof(ConversationNode), "GetDisplayText")]
```
- **대상:** NPC 대화 텍스트
- **처리:** 조사 태그 자동 변환

#### Patch 2: ConversationChoice
```csharp
[HarmonyPatch(typeof(ConversationChoice), "GetDisplayText")]
```
- **대상:** 대화 선택지
- **처리:** 조사 태그 자동 변환

#### Patch 3: GameObject
```csharp
[HarmonyPatch(typeof(GameObject), "GetDisplayName")]
```
- **대상:** 아이템, NPC 이름
- **처리:** 조사 태그 자동 변환

#### Patch 4: MessageQueue
```csharp
[HarmonyPatch(typeof(MessageQueue), "AddPlayerMessage")]
```
- **대상:** 게임 메시지 로그
- **처리:** 조사 태그 자동 변환

---

## 🎯 다음 단계: 첫 번째 테스트

### 테스트 파일: Quests.xml

#### 1. 원본 파일 복사
```bash
cp "/Users/ben/Desktop/무제 폴더/StreamingAssets/Base/Quests.xml" \
   "/Users/ben/Desktop/무제 폴더/StreamingAssets/Base-Work/Translation/"
```

#### 2. 간단한 번역 테스트
```xml
<!-- 원본 -->
<quest Name="WatersEdge" DisplayName="What's Eating the Watervine?">
  <text>Investigate the dying watervine in Joppa.</text>
</quest>

<!-- 번역 + 조사 태그 -->
<quest Name="WatersEdge" DisplayName="워터바인에 무슨 일이?">
  <text>조파<josa_euro_ro> 가서 죽어가는 워터바인<josa_eul_reul> 조사하라.</text>
</quest>
```

#### 3. 모드 폴더에 복사
```bash
cp Translation/Quests.xml Mod/KoreanLocalization/
```

#### 4. 게임에 설치
```bash
# 모드 폴더 확인
mkdir -p ~/Library/Application\ Support/com.FreeholdGames.CavesOfQud/Mods/

# 모드 복사
cp -r Mod/KoreanLocalization \
   ~/Library/Application\ Support/com.FreeholdGames.CavesOfQud/Mods/
```

#### 5. 게임에서 테스트
1. Caves of Qud 실행
2. Mods 메뉴 열기
3. "Korean Localization" 활성화
4. 게임 재시작
5. 퀘스트 확인

---

## 📝 조사 태그 사용법

### 기본 형식
```xml
<단어><josa_type>
```

### 지원하는 조사 타입

| 태그 | 조사 | 예시 |
|------|------|------|
| `<josa_eul_reul>` | 을/를 | 검<josa_eul_reul> → 검을 |
| `<josa_i_ga>` | 이/가 | 사과<josa_i_ga> → 사과가 |
| `<josa_eun_neun>` | 은/는 | 책<josa_eun_neun> → 책은 |
| `<josa_euro_ro>` | 으로/로 | 집<josa_euro_ro> → 집으로 |
| `<josa_a_ya>` | 아/야 | 철수<josa_a_ya> → 철수야 |
| `<josa_wa_gwa>` | 와/과 | 연필<josa_wa_gwa> → 연필과 |

### 실전 예시

```xml
<!-- 대화 -->
<text>당신<josa_i_ga> 검<josa_eul_reul> 발견했다.</text>
<!-- 결과: 당신이 검을 발견했다 -->

<!-- 퀘스트 -->
<text>조파<josa_euro_ro> 가서 메흐메트<josa_wa_gwa> 대화하라.</text>
<!-- 결과: 조파로 가서 메흐메트와 대화하라 -->

<!-- 메시지 -->
<text>사과<josa_eul_reul> 먹었다.</text>
<!-- 결과: 사과를 먹었다 -->
```

---

## 🚨 주의사항

### 1. 변수와 함께 사용 불가 (현재)
```xml
<!-- ❌ 작동 안 함 -->
<text><item.name><josa_eul_reul> 발견했다</text>

<!-- ✅ 고정 텍스트만 가능 -->
<text>검<josa_eul_reul> 발견했다</text>
```

**이유:** 게임 변수 시스템과 통합 필요 (추후 구현)

### 2. XML 문법 준수
```xml
<!-- ❌ 잘못됨 -->
<text>검<josa_eul_reul 발견했다</text>

<!-- ✅ 올바름 -->
<text>검<josa_eul_reul> 발견했다</text>
```

### 3. 태그 이름 정확히
```xml
<!-- ❌ 잘못됨 -->
<text>검<josa_을를> 발견했다</text>

<!-- ✅ 올바름 -->
<text>검<josa_eul_reul> 발견했다</text>
```

---

## 🧪 테스트 체크리스트

- [ ] JosaHandler.cs 복사 완료
- [ ] manifest.json 확인
- [ ] Quests.xml 번역 (1-2개 퀘스트)
- [ ] 모드 폴더에 복사
- [ ] 게임 Mods 폴더에 설치
- [ ] 게임에서 모드 활성화
- [ ] 퀘스트 텍스트 확인
- [ ] 조사 처리 작동 확인

---

## 📊 예상 결과

### 성공 시
```
게임 로그:
[Korean Josa Handler] Harmony patches applied successfully

퀘스트 화면:
워터바인에 무슨 일이?
조파로 가서 죽어가는 워터바인을 조사하라.
```

### 실패 시
```
게임 로그:
[Korean Josa Handler] Failed to apply Harmony patches: ...

해결:
1. 게임 로그 확인
2. JosaHandler.cs 문법 오류 확인
3. manifest.json 확인
```

---

## 🔗 다음 작업

1. **Quests.xml 전체 번역** (1-2일)
2. **Factions.xml 번역** (2-3일)
3. **Conversations.xml 일부 번역** (테스트용)

---

**작성일:** 2026-01-13 10:13  
**상태:** 조사 처리 시스템 완료, 테스트 준비 완료
