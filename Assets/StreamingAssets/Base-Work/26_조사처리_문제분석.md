# 조사 처리 문제 상세 분석

**작성일:** 2026-01-13 13:15  
**문제:** 조사 처리가 완벽하지 않음

---

## 🔍 스크린샷 재분석

### 문제 발견

**이미지 1 (Elder Irudad):**
```
원본 텍스트:
"도착이(으)로 매력이... 그 때문(으)로 이끌렸지, 제의 신과 아이에게..."

문제:
- "도착이(으)로" ← 조사 마커 그대로 표시
- "때문(으)로" ← 조사 마커 그대로 표시
```

**이미지 2:**
```
"우리 신선한 물(을)를 다시도 좋고..."

문제:
- "물(을)를" ← 조사 마커 그대로 표시
```

---

## 🎯 원인 분석

### JosaHandler가 일부만 작동하는 이유

**가능한 원인 3가지:**

#### 1. 텍스트 처리 순서 문제
```
게임 처리 순서:
1. XML 로드
2. 변수 치환 (=player.xxx=)
3. 대화창 표시
4. MessageQueue.Add() 호출 ← JosaHandler 여기서 작동

문제:
- 대화창 텍스트는 MessageQueue를 거치지 않을 수 있음
- 로그 메시지만 처리됨
```

#### 2. Harmony 패치 타겟 부족
```csharp
// 현재: MessageQueue만 패치
[HarmonyPatch(typeof(XRL.Messages.MessageQueue))]

// 필요: 대화창도 패치
[HarmonyPatch(typeof(XRL.UI.ConversationUI))]  // ← 이게 필요
```

#### 3. 정규식 패턴 문제
```csharp
// 현재 패턴
@"(\S+)\(([^)]+)\)([^(\s]*)"

// 문제:
// "도착이(으)로" 같은 복잡한 케이스를 못 잡을 수 있음
```

---

## 💡 해결 방법

### 방법 1: Conversations.xml에서 조사 마커 제거 (추천)

**이유:**
- JosaHandler가 대화창 텍스트를 처리하지 못함
- 가장 확실한 해결책
- 즉시 적용 가능

**수정 예시:**
```xml
<!-- 수정 전 -->
<text>
  도착이(으)로 매력이... 그 때문(으)로 이끌렸지
  우리 신선한 물(을)를 다시도 좋고
</text>

<!-- 수정 후 -->
<text>
  도착으로 매력이... 그 때문으로 이끌렸지
  우리 신선한 물을 다시도 좋고
</text>
```

---

### 방법 2: Harmony 패치 추가 (고급)

**대화창 텍스트 패치 추가:**
```csharp
[HarmonyPatch(typeof(XRL.UI.ConversationUI))]
class ConversationUI_Patch
{
    [HarmonyPostfix]
    [HarmonyPatch("GetText")]  // 또는 다른 메서드
    static void Postfix(ref string __result)
    {
        __result = Korean.ReplaceJosa(__result);
    }
}
```

**문제:**
- 정확한 클래스/메서드 이름을 모름
- 게임 DLL 분석 필요
- 컴파일 에러 가능성

---

## 🔧 즉시 적용 가능한 수정

### Conversations.xml 수정

**찾아야 할 패턴:**
1. `(으)로` → `로` 또는 `으로`
2. `(을)를` → `을` 또는 `를`
3. `(이)가` → `이` 또는 `가`
4. `(에)` → `에`

**수정 대상 (이미지 기준):**

#### Elder Irudad 대화
```xml
<!-- Line 12-18 수정 -->
<text>
  -음. 음? =player.FormalAddressTerm=여?
  
  {{emote|*장로 이루다드가 미소 짓는다.*}}
  
  살아라, 마셔라. 들어오게- 저기 쿠션에 앉게나. 조파로 온 것을 환영하네.
  
  우리의 신선한 물을 마셔도 좋고, 갈증을 풀게나.
</text>
```

#### 다른 대화 노드들
```xml
<!-- 모든 조사 마커 제거 -->
도착이(으)로 → 도착으로
때문(으)로 → 때문으로
물(을)를 → 물을
쿠션(에) → 쿠션에
```

---

## 📊 현재 상태 정리

### 작동하는 것 ✅
- MessageQueue 패치 (로그 메시지)
- 일부 텍스트 처리

### 작동 안 하는 것 ❌
- 대화창 텍스트
- 대부분의 조사 마커

### 결론
**JosaHandler는 로드되었지만 대화창 텍스트를 처리하지 못함**

---

## 🚀 즉시 해결 방법

### 1. Conversations.xml 전체 수정 (15분)
```bash
# 모든 조사 마커 찾기
grep -n "(이)\|(을)\|(으)로\|(에)" Conversations.xml

# 수동으로 하나씩 수정
```

### 2. 자동 치환 스크립트 (5분)
```python
import re

def remove_josa_markers(text):
    # 간단한 패턴만 자동 치환
    text = re.sub(r'물\(을\)를', '물을', text)
    text = re.sub(r'쿠션\(에\)', '쿠션에', text)
    # ... 더 추가
    return text
```

### 3. 게임 재테스트 (5분)
- 수정 후 모드 재설치
- Elder Irudad와 대화
- 조사 확인

---

**결론:**
- JosaHandler는 작동하지만 대화창 텍스트를 처리 못 함
- Conversations.xml에서 조사 마커 제거 필요
- 15분이면 수정 가능
